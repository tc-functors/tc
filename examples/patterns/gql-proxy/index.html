<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <script defer src="https://unpkg.com/alpinejs@3.13.2/dist/cdn.min.js"></script>
    <title>Minimal Appsync Subscription</title>

  </head>
  <body>


    <script>
      function init_rest() {
	return {
	  message: '',
	  postMessage() {
	    fetch('{{REST_ENDPOINT}}/api/trigger', {
	      method: 'POST',
	      header: {
		'Access-Control-Allow-Origin':'*',
	      },
	      body: JSON.stringify({'message': this.message})
	    })
	      .then(res => console.log(res))
	      .then(data => {
		this.status = data;
	      });
	  },
	}
      }


      function init_subscription() {
	return {
	  appsync_host: '{{GRAPHQL_HOST}}',
	  appsync_realtime_host: '{{GRAPHQL_REALTIME_HOST}}',
	  appsync_api_key: '{{GRAPHQL_API_KEY}}',

	  messages: [],
	  conj(m) {
	    this.messages.push(m)
	  },

	  encodeAppSyncCredentials() {
	    const creds = {
	      host: this.appsync_host,
	      "x-api-key": this.appsync_api_key,
	    };
	    const b64Creds = window.btoa(JSON.stringify(creds));
	    return b64Creds;
	  },

	  getWebsocketUrl() {
	    const header = this.encodeAppSyncCredentials();
	    const payload = window.btoa(JSON.stringify({}));
	    const url = `wss://${this.appsync_realtime_host}/graphql?header=${header}&payload=${payload}`;
	    return url;
	  },

	  subscribeProcessMessage:
	  `subscription SubscribeProcessMessage($id: String!) {
            subscribeProcessMessage(id: $id) {
              id
              text
              createdAt
              updatedAt
	      __typename
	    }
	  }
	  `,
	  startSubscription(websocket) {
	    const subscribeMessage = {
	      id: window.crypto.randomUUID(),
	      type: "start",
	      payload: {
		data: JSON.stringify({
		  query: this.subscribeProcessMessage,
		  variables: {
		    id: 'abc'
		  }
		}),
		extensions: {
		  authorization: {
		    "x-api-key": this.appsync_api_key,
		    host: this.appsync_host,
		  },
		},
	      },
	    };
	    websocket.send(JSON.stringify(subscribeMessage));
	  },

	  init() {
	    const url = this.getWebsocketUrl();
	    const socket = new WebSocket(url, ["graphql-ws"]);
	    socket.onopen = () => {
	      socket.send(
		JSON.stringify({
		  type: "connection_init",
		})
	      );
	    }
	    socket.onclose = (event) => reject(new Error(event.reason))

	    socket.onmessage = (event) => {
	      message = JSON.parse(event.data);
	      console.log(message);
	      switch (message.type) {
	      case "connection_ack":
		this.startSubscription(socket);
		break;
	      case "start_ack":
		console.log("start_ack");
		break;
	      case "error":
		console.log(message);
		console.error(message);
		break;
	      case "data":
		const text = message.payload.data.subscribeProcessMessage.text;
		console.log(text)
		this.conj(text)
		break;
	      }
	    }
	  } // eof init
	}
      }

    </script>



    <div class="container grid">

      <div x-data="init_rest()">
	<br/>
	<h4>Post Message</h4>
	<textarea rows=10 x-model="message"> </textarea>
	<button @click="postMessage()">Post Message</button>

      </div>


      <div x-data="init_subscription()">
	<br/>
	<br/>

	<div style="height: 80dvh;" class="overflow-auto">
	  <template x-for="msg in messages">
	    <div>
	      <div x-html="msg"></div>
	      <hr/>
	    </div>
	  </template>

	</div>

      </div>
    </div>

  </body>

</html>
