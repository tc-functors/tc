<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <script defer src="https://unpkg.com/alpinejs@3.13.2/dist/cdn.min.js"></script>
    <title>API Async</title>
  </head>
  <body>

    <div class="container">
      <br/>
      <div class="grid">
	<div>
	  <script>
	    function init_rest() {
	      return {
		message: '',
		status: '',
		postMessage() {
		  fetch('{{REST_ENDPOINT}}/api/message', {
		    method: 'POST',
		    header: {
		      'Access-Control-Allow-Origin':'*',
		    },
		    body: JSON.stringify({'message': this.message})
		  })
		    .then(res => console.log(res))
		    .then(data => {
		      this.status = data;
		    });
		},
	      }
	    }
	  </script>
	  <div x-data="init_rest()">
	    <h4>Request (REST)</h4>
	    <textarea rows=10 x-model="message"> </textarea>
	    <button @click="postMessage()">Post Message</button>
	  </div>

	</div>

	<div>
	  <script>
	  function init_subscription() {
	    return {
	      channel: '{{CHANNEL}}',
	      message: '',
	      messages: [],
	      conj(m) {
		const data = JSON.parse(m.data)
		console.log(data);
		if ( data.type == "data" ) {
		  const event =  JSON.parse(data.event)
		  this.messages.push(event.message)
		}
	      },
	      auth: { 'x-api-key': '{{API_KEY}}', host: '{{HTTP_DOMAIN}}' },
	      getAuthProtocol() {
		const header = btoa(JSON.stringify(this.auth))
		      .replace(/\+/g, '-') // Convert '+' to '-'
		      .replace(/\//g, '_') // Convert '/' to '_'
		      .replace(/=+$/, '') // Remove padding `=`
		return `header-${header}`
	      },
	      async subscribe() {
		const socket = await new Promise((resolve, reject) => {
		  const socket = new WebSocket("wss://{{REALTIME_DOMAIN}}/event/realtime", [
		    'aws-appsync-event-ws',
		    this.getAuthProtocol(),
		  ])
		  socket.onopen = () => resolve(socket)
		  socket.onclose = (event) => reject(new Error(event.reason))
		  socket.onmessage = (event) => this.conj(event)


		})
		const event = {
		  "type": "subscribe",
		  "id": crypto.randomUUID(),
		  "channel": this.channel,
		  "authorization": this.auth
		}
		socket.send(JSON.stringify(event))
	      },

	      async send_msg() {
		const event = {
		  "channel": this.channel,
		  "events": [
		    JSON.stringify({message: this.message})
		  ]
		}
		const response = await fetch(`https://{{HTTP_DOMAIN}}/event`, {
		  method: 'POST',
		  headers: this.auth,
		  body: JSON.stringify(event)
		})
		this.message = ''
	      }

	    }
	  }
	  </script>

	<div x-data="init_subscription()" x-init="subscribe()">
	  <h4>Response (Websocket)</h4>

	  <template x-for="message in messages">
            <div>
              <div x-html="message"></div>
              <hr/>
            </div>
	  </template>
      </div>
    </div>

  </body>
</html>
