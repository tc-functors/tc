<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <script defer src="https://unpkg.com/alpinejs@3.13.2/dist/cdn.min.js"></script>
    <title>GQL Tracker</title>

  </head
  <body>

    <div class="container">

    <script>
      function init_subscription() {
	return {
	  appsync_host: '{{GRAPHQL_HOST}}',
	  appsync_realtime_host: '{{GRAPHQL_REALTIME_HOST}}',
	  appsync_api_key: '{{GRAPHQL_API_KEY}}',

	  job_id: '',
	  startJob:
	  `mutation StartJob($id: String!) {
               startJob(id: $id) {
                 id
                 status
                 message
                 createdAt
                 updatedAt
                 __typename
              }
            }`,

	  trigger_mutation() {
	    fetch('{{GRAPHQL_ENDPOINT}}', {
	      method: 'POST',
	      headers: {
		'Content-Type':'application/graphql',
		'Access-Control-Allow-Origin':'*',
		'x-api-key': this.appsync_api_key
	      },
	      body: JSON.stringify(
		{'query': this.startJob, 'variables': {'id': this.job_id }}
	      )
	    })
	      .then(res => console.log(res))
	      .then(data => {
		this.status = data;
	      });
	  },
	  // subscriptions

	  messages: [],
	  conj(m) {
	    this.messages.push(m)
	  },

	  encodeAppSyncCredentials() {
	    const creds = {
	      host: this.appsync_host,
	      "x-api-key": this.appsync_api_key,
	    };
	    const b64Creds = window.btoa(JSON.stringify(creds));
	    return b64Creds;
	  },

	  getWebsocketUrl() {
	    const header = this.encodeAppSyncCredentials();
	    const payload = window.btoa(JSON.stringify({}));
	    const url = `wss://${this.appsync_realtime_host}/graphql?header=${header}&payload=${payload}`;
	    return url;
	  },

	  subscribeStartJob:
	     `subscription SubscribeStartJob($id: String!) {
               subscribeStartJob(id: $id) {
                 id
                 status
                 message
                 createdAt
                 updatedAt
                __typename
             }
          }`,

	  subscribeCompleteJob:
            `subscription SubscribeCompleteJob($id: String!) {
               subscribeCompleteJob(id: $id) {
                 id
                 status
                 message
                 createdAt
                 updatedAt
                 __typename
           }
         }`,

	  sendQuery(websocket, query) {
            console.log("subscribing ", this.job_id);
	    const payload = {
	      id: window.crypto.randomUUID(),
	      type: "start",
	      payload: {
		data: JSON.stringify({
		  query: query,
		  variables: {
		    id: this.job_id
		  }
		}),
		extensions: {
		  authorization: {
		    "x-api-key": this.appsync_api_key,
		    host: this.appsync_host,
		  },
		},
	      },
	    };
	    websocket.send(JSON.stringify(payload));
	  },

	  subscribe() {
	    const url = this.getWebsocketUrl();
	    const socket = new WebSocket(url, ["graphql-ws"]);
	    socket.onopen = () => {
	      socket.send(
		JSON.stringify({
		  type: "connection_init",
		})
	      );
	    }
	    socket.onclose = (event) => reject(new Error(event.reason))

	    socket.onmessage = (event) => {
	      message = JSON.parse(event.data);
	      console.log(message);
	      switch (message.type) {
	      case "connection_ack":
		this.sendQuery(socket, this.subscribeStartJob);
		this.sendQuery(socket, this.subscribeCompleteJob);
		break;
	      case "start_ack":
		console.log("start_ack");
		break;
	      case "error":
		console.error(message);
		break;
	      case "data":
		const text1 = message.payload.data.subscribeStartJob;
		const text2 = message.payload.data.subscribeCompleteJob;
		if (text1) {
		  this.conj(text1)
		}
		if (text2) {
		  this.conj(text2)
		}

		break;
	      }
	    }
	  }, // eof subscribe

	  start() {
	    this.subscribe()
	    this.trigger_mutation()
	  }

	}
      }

    </script>


    <div x-data="init_subscription()">

      <br/>
      <div class="grid">
	<fieldset role="group">
	  <input type="text" x-model="job_id"/>
	  <input type="submit" @click="start()" value="Start Job">
	</fieldset>
	<div></div>
      </div>


	 <article class="secondary" style="height: 80dvh;" class="overflow-auto">
	   <template x-for="msg in messages">
             <div>
	       <span x-text="msg.id"></span>
	       <span x-text="msg.status"></span>
	       <hr/>
             </div>
	    </template>

	  </article>

    </div>

    </div>

  </body>

</html>
