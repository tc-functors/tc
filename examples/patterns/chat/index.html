<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
    <script defer src="https://unpkg.com/alpinejs@3.13.2/dist/cdn.min.js"></script>
    <title>Simple Chat</title>

  </head>
  <body>
    <div class="container">
      <br/>
      <h4>Chat</h4>

      <div class="grid">
	<script>

	  function init_subscription() {
	    return {
	      channel: '{{CHANNEL}}',
	      message: '',
	      messages: [],
	      conj(m) {
		const data = JSON.parse(m.data)
		console.log(data);
		if ( data.type == "data" ) {
		  const event =  JSON.parse(data.event)
		  this.messages.push(event.message)
		}
	      },
	      auth: { 'x-api-key': '{{API_KEY}}', host: '{{HTTP_DOMAIN}}' },
	      getAuthProtocol() {
		const header = btoa(JSON.stringify(this.auth))
		      .replace(/\+/g, '-') // Convert '+' to '-'
		      .replace(/\//g, '_') // Convert '/' to '_'
		      .replace(/=+$/, '') // Remove padding `=`
		return `header-${header}`
	      },
	      async subscribe() {
		const socket = await new Promise((resolve, reject) => {
		  const socket = new WebSocket("wss://{{REALTIME_DOMAIN}}/event/realtime", [
		    'aws-appsync-event-ws',
		    this.getAuthProtocol(),
		  ])
		  socket.onopen = () => resolve(socket)
		  socket.onclose = (event) => reject(new Error(event.reason))
		  socket.onmessage = (event) => this.conj(event)


		})
		const event = {
		  "type": "subscribe",
		  "id": crypto.randomUUID(),
		  "channel": this.channel,
		  "authorization": this.auth
		}
		socket.send(JSON.stringify(event))
	      },

	      async send_msg() {
		const event = {
		  "channel": this.channel,
		  "events": [
		    JSON.stringify({message: this.message})
		  ]
		}
		const response = await fetch(`https://{{HTTP_DOMAIN}}/event`, {
		  method: 'POST',
		  headers: this.auth,
		  body: JSON.stringify(event)
		})
		this.message = ''
	      }

	    }
	  }

	</script>

	<div x-data="init_subscription()" x-init="subscribe()">

	  <article class="secondary" style="height: 80dvh;" class="overflow-auto">
	    <template x-for="msg in messages">
              <div>
		<div x-html="msg"></div>
		<hr/>
              </div>
	    </template>

	  </article>

	  <input @keyup.enter="send_msg()" type="text" placeholder="Enter the message" style="width:80%;" x-model="message">
	  <button type="submit"  @click="send_msg()" style="display:inline;min-width:fit-content; width: calc(20% - 6px)">
	    <i class='fas fa-paper-plane'></i>
	  </button>

	</div>

	<div>
	</div>

      </div>

    </div>
  </body>
</html>
