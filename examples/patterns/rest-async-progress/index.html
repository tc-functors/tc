<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <script defer src="https://unpkg.com/alpinejs@3.13.2/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/yaml.min.js"></script>
    <title>API Async</title>
  </head>
  <body>

    <div class="container">
      <br/>
      <div class="grid">
	<div>
	  <script>hljs.highlightAll();</script>
	  <pre><code class="language-yaml">
name: example-rest-progress

routes:
  /api/message:
    method: POST
    event: ProcessStart

events:
  ProcessStart:
    function: f1

functions:
  f1:
    function: f2
    channel: my-channel
  f2:
    function: f3
    channel: my-channel
  f3:
    channel: my-channel

channels:
  my-channel:
    handler: default

pages:
  app:
    dir: .
    dist: dist
    config_template: index.html
    skip_deploy: true

	  </code></pre>
	</div>

	<div>
	  <script>
	    function init_rest() {
	      return {
		message: '',
		postMessage() {
		  fetch('{{REST_ENDPOINT}}/api/message', {
		    method: 'POST',
		    header: {
		      'Access-Control-Allow-Origin':'*',
		    },
		    body: JSON.stringify({'message': this.message})
		  })
		    .then(res => console.log(res))
		    .then(data => {
		      this.status = data;
		    });
		},
	      }
	    }
	  </script>
	  <div x-data="init_rest()">
	    <h4>Request (REST)</h4>
	    <textarea rows=10 x-model="message"> </textarea>
	    <button @click="postMessage()">Post Message</button>

	  </div>

	</div>

	<div>
	  <script>
	  function init_subscription() {
	    return {
	      channel: '{{CHANNEL}}',
	      message: '',
	      messages: [],
	      status: 1,
	      conj(m) {
		const data = JSON.parse(m.data)
		console.log(data);
		if ( data.type == "data" ) {
		  const event =  JSON.parse(data.event)
		  this.messages.push(event.message);
		  this.status = event.status
		}
	      },
	      auth: { 'x-api-key': '{{API_KEY}}', host: '{{HTTP_DOMAIN}}' },
	      getAuthProtocol() {
		const header = btoa(JSON.stringify(this.auth))
		      .replace(/\+/g, '-') // Convert '+' to '-'
		      .replace(/\//g, '_') // Convert '/' to '_'
		      .replace(/=+$/, '') // Remove padding `=`
		return `header-${header}`
	      },
	      async subscribe() {
		const socket = await new Promise((resolve, reject) => {
		  const socket = new WebSocket("wss://{{REALTIME_DOMAIN}}/event/realtime", [
		    'aws-appsync-event-ws',
		    this.getAuthProtocol(),
		  ])
		  socket.onopen = () => resolve(socket)
		  socket.onclose = (event) => reject(new Error(event.reason))
		  socket.onmessage = (event) => this.conj(event)


		})
		const event = {
		  "type": "subscribe",
		  "id": crypto.randomUUID(),
		  "channel": this.channel,
		  "authorization": this.auth
		}
		socket.send(JSON.stringify(event))
	      }

	    }
	  }
	  </script>

	<div x-data="init_subscription()" x-init="subscribe()">
	  <h4>Response (Websocket)</h4>

	  <br/>
	  <template x-for="msg in messages">
            <div>
              <div x-html="msg"></div>
              <hr/>
            </div>
	  </template>
	  </br/>
	  <span x-text="status"></span>
	  <progress x-bind:value="status" max="100"/>

      </div>
    </div>

  </body>
</html>
